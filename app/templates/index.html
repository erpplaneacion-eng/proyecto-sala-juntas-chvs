<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva de Salas - CHVS</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- FullCalendar CSS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <!-- Bootstrap CSS for Modals and Layout -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header class="navbar sticky-top flex-md-nowrap p-0 shadow-lg chvs-header">
        <div class="container d-flex align-items-center justify-content-between p-3">
            <h1 class="h4 mb-0 text-white font-weight-bold d-flex align-items-center">
                <i data-lucide="building-2" class="me-2"></i> CHVS
            </h1>
            <span class="text-white d-none d-md-inline fw-light opacity-75 small">Sistema Inteligente de Reserva de Salas</span>
        </div>
    </header>

    <div class="container mt-5 mb-5">
        <div class="row g-4">
            <div class="col-lg-3">
                <div class="card shadow-lg border-0 room-selector overflow-hidden">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="card-title text-emerald mb-0 d-flex align-items-center fw-bold">
                            <i data-lucide="layout" class="me-2"></i> Salas
                        </h5>
                    </div>
                    <div class="card-body pt-0">
                        {% for room in rooms %}
                        <div class="room-item mb-3 p-3 rounded shadow-sm" style="border-left: 5px solid {{ room.color }}">
                            <div class="fw-bold mb-1">{{ room.name }}</div>
                            <div class="text-muted small lh-sm">{{ room.description }}</div>
                            {% if room.capacity %}
                            <div class="small mt-1 d-flex align-items-center" style="color: #62B33E;">
                                <i data-lucide="users" style="width:13px;height:13px;" class="me-1"></i>
                                Capacidad: <strong class="ms-1">{{ room.capacity }} personas</strong>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        <button class="btn btn-emerald w-100 mt-2 py-2 fw-bold shadow-sm d-flex align-items-center justify-content-center" data-bs-toggle="modal" data-bs-target="#bookingModal">
                            <i data-lucide="plus-circle" class="me-2 size-5"></i> Nueva Reserva
                        </button>
                    </div>
                </div>

                <div class="card shadow-sm border-0 mt-4 info-card bg-emerald text-white overflow-hidden position-relative">
                    <div class="card-body p-4 position-relative z-1">
                        <h6 class="opacity-75 mb-1 small fw-bold">DISPONIBILIDAD</h6>
                        <p class="h5 mb-0 fw-bold d-flex align-items-center">
                            <i data-lucide="clock" class="me-2"></i> 7:00 AM - 5:00 PM
                        </p>
                    </div>
                    <div class="position-absolute bottom-0 end-0 p-2 opacity-25">
                        <i data-lucide="calendar-check-2" size="64"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-9">
                <div class="card shadow-lg border-0 calendar-card rounded-4">
                    <div class="card-body p-4">
                        <div id='calendar'></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-2xl rounded-4">
                <div class="modal-header bg-white border-0 pt-4 px-4 pb-0">
                    <h4 class="modal-title fw-bold text-dark d-flex align-items-center" id="bookingModalLabel">
                        <i data-lucide="calendar-plus" class="text-emerald me-2"></i> Reservar Sala
                    </h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="bookingForm" class="needs-validation">
                        <div class="mb-3">
                            <label for="user_name" class="form-label small fw-bold text-muted">NOMBRE COMPLETO</label>
                            <input type="text" class="form-control form-control-lg bg-light border-0" id="user_name" name="user_name" placeholder="Ej: Juan Pérez" required>
                        </div>
                        <div class="mb-3">
                            <label for="user_email" class="form-label small fw-bold text-muted">CORREO CORPORATIVO</label>
                            <input type="email" class="form-control form-control-lg bg-light border-0" id="user_email" name="user_email" placeholder="nombre@vallesolidario.org" required>
                        </div>
                        <div class="mb-3">
                            <label for="area" class="form-label small fw-bold text-muted">ÁREA / DEPARTAMENTO</label>
                            <select class="form-select form-select-lg bg-light border-0" id="area" name="area" required>
                                <option value="" disabled selected>Seleccione área...</option>
                                <option value="Administración">Administración</option>
                                <option value="Proyectos">Proyectos</option>
                                <option value="Social">Social</option>
                                <option value="Operaciones">Operaciones</option>
                            </select>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <label for="room_id" class="form-label small fw-bold text-muted">SALA DE JUNTAS</label>
                                <select class="form-select form-select-lg bg-light border-0" id="room_id" name="room_id" required>
                                    {% for room in rooms %}
                                    <option value="{{ room.id }}" data-capacity="{{ room.capacity or 99 }}">
                                        {{ room.name }}{% if room.capacity %} (máx. {{ room.capacity }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="attendees" class="form-label small fw-bold text-muted">ASISTENTES</label>
                                <input type="number" class="form-control form-control-lg bg-light border-0" id="attendees" name="attendees" value="1" min="1" required>
                                <div id="attendees_hint" class="form-text small" style="color:#62B33E;"></div>
                            </div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-12">
                                <label for="booking_date" class="form-label small fw-bold text-muted">FECHA</label>
                                <input type="date" class="form-control form-control-lg bg-light border-0" id="booking_date" name="booking_date" required min="{{ now }}">
                            </div>
                            <div class="col-md-6">
                                <label for="start_time" class="form-label small fw-bold text-muted">INICIO (7 AM - 5 PM)</label>
                                <input type="time" class="form-control form-control-lg bg-light border-0" id="start_time" name="start_time" required min="07:00" max="17:00">
                            </div>
                            <div class="col-md-6">
                                <label for="end_time" class="form-label small fw-bold text-muted">FIN</label>
                                <input type="time" class="form-control form-control-lg bg-light border-0" id="end_time" name="end_time" required min="07:00" max="17:00">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-emerald btn-lg w-100 py-3 fw-bold shadow-sm transition-all">
                            Finalizar Reserva
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        lucide.createIcons();

        // Capacidades por sala (inyectadas desde el servidor)
        const roomCapacities = {
            {% for room in rooms %}
            {{ room.id }}: {{ room.capacity or 99 }}{% if not loop.last %},{% endif %}
            {% endfor %}
        };

        const roomSelect = document.getElementById('room_id');
        const attendeesInput = document.getElementById('attendees');
        const attendeesHint = document.getElementById('attendees_hint');

        function updateAttendeesMax() {
            const cap = roomCapacities[roomSelect.value];
            if (cap) {
                attendeesInput.max = cap;
                attendeesHint.textContent = `Máximo ${cap} personas`;
            }
        }

        roomSelect.addEventListener('change', updateAttendeesMax);
        updateAttendeesMax();
    </script>
    <script src="/static/js/calendar.js"></script>
</body>
</html>
